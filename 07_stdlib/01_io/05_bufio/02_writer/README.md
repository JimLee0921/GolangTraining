# `bufio.Writer`

`bufio.Writer` 是一个带缓冲的输出写入器，Writer 实现了 `io.Writer` 对象（比如文件、网络连接）的缓冲功能。
外包一层缓冲区，让小的写入操作被聚合成大的块，从而减少系统调用次数、提升性能。

> 多次小写 -> 内存缓冲 -> 一次大写（Flush 时写出）
>
> 如果写入Writer时发生错误，则不会再接受任何数据，并且所有后续写入操作以及Writer.Flush都会返回错误。
> 所有数据写入完成后，客户端应调用 Writer.Flush 方法，以确保所有数据都已转发至底层io.Writer。

## 定义创建

| 创建方式   | 函数                                           | 缓冲区大小        | 说明       |
|--------|----------------------------------------------|--------------|----------|
| 默认缓冲区  | `bufio.NewWriter(w io.Writer)`               | 4096 字节（4KB） | 默认缓冲     |
| 自定义缓冲区 | `bufio.NewWriterSize(w io.Writer, size int)` | 指定的大小        | 可优化性能或延迟 |

常见底层目标：

- 文件 (*os.File)
- 网络连接 (net.Conn)
- 标准输出 (os.Stdout)
- 内存缓冲 (bytes.Buffer)

```
// 默认 4KB 缓冲
w1 := bufio.NewWriter(file)
// 自定义 16KB 缓冲
w2 := bufio.NewWriterSize(file, 16*1024)
```

## 写入数据流程

数据 -> `bufio.Writer`(缓冲区) -> `Flush()` -> `io.Writer`(文件/网络)

- 数据先写入内存缓冲区
- 当缓冲区满时回自动调用 `Flush` 写入文件或流，或手动调用 `Flush()` 时才真正写到底层 io.Writer（比如文件或 socket）

> 即使写了很多单字节，也必须最后调用 `Flush()` 否则最后那部分缓冲内容不会写出。

## 缓冲区大小

| 场景     | 推荐缓冲区大小  | 说明          |
|--------|----------|-------------|
| 普通文件写入 | 4KB（默认）  | 已够用         |
| 高频日志写入 | 8KB–32KB | 减少 Flush 次数 |
| 网络流    | 1KB–8KB  | 平衡延迟与吞吐     |
| 大文件顺序写 | 32KB+    | 最大化写入性能     |

## 注意事项

1. 一定要在最后调用 `Flush()`，否则数据还在内存中，可以使用 `defer w.Flush` 确保安全
2. 多线程同时写入需要加锁（Writer 不并发安全）
